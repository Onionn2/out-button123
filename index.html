<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>笑ってはいけない アウトボタン（完全版）</title>

<style>
body {
  margin: 0;
  height: 100vh;
  background: #ffffff;
  font-family: Arial, sans-serif;
  display: flex;
  flex-direction: column;
  justify-content: space-around;
  align-items: center;
}

#message {
  font-size: 3.5rem;
  font-weight: bold;
  color: #000;
}

.buttons {
  width: 94vw;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
}

.outButton {
  height: 20vh;
  font-size: 3rem;
  background: red;
  color: white;
  border: none;
  border-radius: 18px;
}

.allOut {
  grid-column: span 2;
  background: darkred;
  height: 18vh;
}

.gaugeContainer {
  width: 85vw;
  height: 26px;
  background: #ddd;
  border-radius: 13px;
  overflow: hidden;
}

.gauge {
  width: 100%;
  height: 100%;
  background: red;
}

#gaugeText {
  font-size: 1.5rem;
  font-weight: bold;
  color: #000;
}
</style>
</head>

<body>

<div id="message">アウト！</div>

<div class="buttons">
  <button class="outButton" data-name="けいと" data-sound="keito">けいと</button>
  <button class="outButton" data-name="そら" data-sound="sora">そら</button>
  <button class="outButton" data-name="和田" data-sound="wada">和田</button>
  <button class="outButton" data-name="櫻井" data-sound="sakurai">櫻井</button>
  <button class="outButton allOut" data-name="全員" data-sound="all">
    全員アウト
  </button>
</div>

<div id="gaugeText"></div>
<div class="gaugeContainer">
  <div class="gauge" id="gauge"></div>
</div>

<script>
/* ===== iOS Safari 音声アンロック ===== */
let audioUnlocked = false;
let audioContext = null;

function unlockAudio() {
  if (audioUnlocked) return;
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  audioContext.resume();
  audioUnlocked = true;
}

/* ===== 音声事前ロード ===== */
const soundSources = {
  keito: new Audio("keito.mp3"),
  sora: new Audio("sora.mp3"),
  wada: new Audio("wada.mp3"),
  sakurai: new Audio("sakurai.mp3"),
  all: new Audio("all.mp3")
};

for (const k in soundSources) {
  soundSources[k].preload = "auto";
}

/* ===== UI ===== */
const buttons = document.querySelectorAll('.outButton');
const message = document.getElementById('message');
const gauge = document.getElementById('gauge');
const gaugeText = document.getElementById('gaugeText');

const DURATION = 4;
let startTime = 0;
let timer = null;

buttons.forEach(btn => {
  btn.onclick = () => {
    unlockAudio(); // ★最重要（最初の1回）

    const name = btn.dataset.name;
    const key = btn.dataset.sound;

    message.textContent = name + " OUT！";

    /* ===== 確実再生（cloneNode方式） ===== */
    const audio = soundSources[key].cloneNode(true);
    audio.currentTime = 0;
    audio.play().catch(() => {});

    /* ===== タイマーリセット ===== */
    startTime = Date.now();
    gauge.style.width = "100%";

    if (!timer) {
      timer = setInterval(update, 60); // 軽量更新
    }
  };
});

function update() {
  const elapsed = (Date.now() - startTime) / 1000;
  const remain = DURATION - elapsed;

  if (remain <= 0) {
    gauge.style.width = "0%";
    gaugeText.textContent = "";
    clearInterval(timer);
    timer = null;
    return;
  }

  gauge.style.width = (remain / DURATION * 100) + "%";
  gaugeText.textContent = remain.toFixed(1) + "s";
}
</script>

</body>
</html>
